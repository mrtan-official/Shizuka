<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shizuka AI Assistant Pro</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #2d3436;
            --glass: rgba(255, 255, 255, 0.98);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --neon-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 10px;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 107, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(78, 205, 196, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 40% 40%, rgba(102, 126, 234, 0.1) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .container {
            width: 100%; 
            max-width: 500px; 
            height: 92vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                inset 0 1px 0 rgba(255,255,255,0.8),
                var(--neon-shadow);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
        }

        .header { 
            background: linear-gradient(135deg, var(--primary), #ff8e8e);
            padding: 20px; 
            text-align: center; 
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite linear;
            z-index: -1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .logo-container {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: float 3s ease-in-out infinite;
            border: 3px solid var(--secondary);
        }

        .logo-container img {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .header h1 {
            font-size: 1.5rem; 
            color: white; 
            margin-bottom: 5px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 0.8rem; 
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .header .badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            color: white;
            backdrop-filter: blur(10px);
        }

        .chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            scroll-behavior: smooth;
            background: 
                linear-gradient(180deg, 
                    rgba(248, 249, 250, 0.8) 0%, 
                    rgba(255, 255, 255, 0.9) 100%);
            position: relative;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .message { 
            margin-bottom: 20px; 
            display: flex; 
            flex-direction: column; 
            animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            position: relative;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .message::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.9rem;
            color: white;
            z-index: 2;
        }

        .user::before {
            content: 'üë§';
            right: -35px;
            top: 0;
            background: var(--primary);
        }

        .assistant::before {
            content: 'ü§ñ';
            left: -35px;
            top: 0;
            background: var(--secondary);
        }

        .message-content { 
            padding: 16px 20px; 
            border-radius: 24px; 
            max-width: 85%; 
            font-size: 0.95rem; 
            line-height: 1.5; 
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.08),
                0 1px 0 rgba(0,0,0,0.02);
            position: relative;
            backdrop-filter: blur(10px);
            word-break: break-word;
        }

        .message-content a { 
            color: #667eea; 
            text-decoration: none; 
            font-weight: 600;
            border-bottom: 2px dotted #667eea;
            transition: all 0.3s;
        }

        .message-content a:hover {
            color: #764ba2;
            border-bottom-style: solid;
        }

        .message-content code { 
            background: rgba(0,0,0,0.05); 
            padding: 2px 8px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85em;
            color: #e74c3c;
            font-weight: 600;
        }

        .user { align-items: flex-end; }
        .user .message-content { 
            background: linear-gradient(135deg, var(--primary), #ff8e8e);
            color: white; 
            border-bottom-right-radius: 8px;
            border-top-right-radius: 8px;
            border-top-left-radius: 24px;
            margin-right: 15px;
        }

        .assistant { align-items: flex-start; }
        .assistant .message-content { 
            background: white; 
            color: var(--dark); 
            border-bottom-left-radius: 8px;
            border-top-left-radius: 8px;
            border-top-right-radius: 24px;
            margin-left: 15px;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .app-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            padding: 20px; 
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .app-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--primary), 
                var(--secondary), 
                transparent);
        }

        .app-icon { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 0.7rem; 
            cursor: pointer; 
            color: #555; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            padding: 8px 5px;
            border-radius: 12px;
            position: relative;
            z-index: 1;
        }

        .app-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9));
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .app-icon:hover { 
            transform: translateY(-5px) scale(1.05); 
            color: var(--dark);
        }

        .app-icon:hover::before {
            opacity: 1;
        }

        .app-icon i { 
            width: 50px; 
            height: 50px; 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.4rem; 
            margin-bottom: 6px; 
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.5);
            transition: all 0.3s; 
            position: relative;
            overflow: hidden;
        }

        .app-icon i::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .app-icon:hover i::after {
            opacity: 1;
        }

        .input-area { 
            padding: 20px; 
            background: white; 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            border-top: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .input-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--secondary), 
                var(--primary), 
                transparent);
        }

        input { 
            flex: 1; 
            padding: 16px 20px; 
            border: 2px solid #f0f0f0; 
            background: #f8f9fa; 
            border-radius: 25px; 
            outline: none; 
            font-size: 0.95rem; 
            transition: all 0.3s;
            color: var(--dark);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
        }

        input:focus { 
            border-color: var(--secondary); 
            background: white;
            box-shadow: 
                0 0 0 3px rgba(78, 205, 196, 0.1),
                inset 0 2px 8px rgba(0,0,0,0.04);
        }

        input::placeholder {
            color: #aaa;
        }

        .btn-round { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-round::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-round:hover::after {
            opacity: 1;
        }

        .btn-round:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.15),
                inset 0 1px 0 rgba(255,255,255,0.4);
        }

        .btn-round i {
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .btn-send { 
            background: linear-gradient(135deg, var(--primary), #ff8e8e); 
            color: white; 
        }

        .btn-mic { 
            background: linear-gradient(135deg, var(--secondary), #7ae0d8); 
            color: white; 
        }

        .btn-mic.listening { 
            background: linear-gradient(135deg, #ff4757, #ff6b81); 
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 
                0 0 20px rgba(255, 71, 87, 0.4),
                0 6px 20px rgba(0,0,0,0.1);
        }

        @keyframes pulse { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            backdrop-filter: blur(5px);
        }

        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 25px; 
            width: 90%; 
            max-width: 400px; 
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            animation: modalAppear 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        @keyframes modalAppear {
            from { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .modal-content h2 { 
            margin-bottom: 20px; 
            color: var(--dark); 
            font-weight: 700;
            font-size: 1.5rem;
        }

        .modal-content input { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #e0e0e0; 
            border-radius: 12px; 
            font-size: 1rem;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .modal-content input:focus {
            border-color: var(--secondary);
            background: white;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .modal-buttons { 
            display: flex; 
            gap: 10px; 
            margin-top: 25px; 
        }

        .modal-buttons button { 
            flex: 1; 
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .modal-buttons button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-buttons button:hover::after {
            opacity: 1;
        }

        .btn-close { 
            background: #f1f2f6; 
            color: #333; 
        }

        .btn-close:hover {
            background: #e4e5e9;
            transform: translateY(-2px);
        }

        .btn-ok { 
            background: linear-gradient(135deg, var(--primary), #ff8e8e); 
            color: white; 
        }

        .btn-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .typing-indicator {
            display: flex;
            padding: 15px 20px;
            gap: 6px;
            background: white;
            border-radius: 24px;
            width: fit-content;
            margin-left: 15px;
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.08),
                0 1px 0 rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--dark);
            opacity: 0.4;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { 
                opacity: 0.4; 
                transform: translateY(0); 
            }
            30% { 
                opacity: 1; 
                transform: translateY(-8px); 
            }
        }

        .command-tip {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9));
            border-radius: 15px;
            margin: 10px 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            animation: tipSlide 0.5s ease-out;
            line-height: 1.4;
        }

        @keyframes tipSlide {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .time-stamp {
            font-size: 0.7rem;
            color: #999;
            margin-top: 5px;
            text-align: center;
            opacity: 0.7;
        }

        .user .time-stamp {
            text-align: right;
            margin-right: 15px;
        }

        .assistant .time-stamp {
            text-align: left;
            margin-left: 15px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            color: #555;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .welcome-container {
            text-align: center;
            padding: 30px 20px;
            animation: welcomeAppear 0.8s ease-out;
        }

        @keyframes welcomeAppear {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2ecc71;
            position: absolute;
            top: 20px;
            left: 20px;
            box-shadow: 0 0 10px #2ecc71;
            animation: pulse 2s infinite;
        }

        .ai-response {
            border-left: 4px solid var(--secondary);
            padding-left: 15px;
            margin: 5px 0 5px 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-container">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="Logo">
        </div>
        <h1>‚ú® Shizuka AI Pro</h1>
        <p>Developer: Abu Tanim | Version 2.1</p>
        <div class="badge">AI Assistant</div>
    </div>

    <div class="command-tip">
        ‚ú® Try saying: "tell me a joke", "sing a song", or "play tic-tac-toe"
    </div>

    <div class="chat-container" id="chat"></div>

    <div class="app-grid" id="gridContainer"></div>

    <div class="input-area">
        <button class="btn-round btn-mic" id="mic" onclick="toggleVoice()" title="Voice Input">
            <i class="fas fa-microphone"></i>
        </button>
        <input type="text" id="msgInput" placeholder="Type or say something..." autocomplete="off">
        <button class="btn-round btn-send" onclick="sendMsg()" title="Send">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Enter Name</h2>
        <input type="text" id="modalInput" placeholder="Enter here..." autocomplete="off">
        <div class="modal-buttons">
            <button class="btn-close" onclick="closeModal()">Cancel</button>
            <button class="btn-ok" onclick="submitModal()">OK</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://shizuka-ai-assistant.onrender.com';
    const chat = document.getElementById('chat');
    const input = document.getElementById('msgInput');
    
    let userName = sessionStorage.getItem('shizuka_user_name') || '';
    let selectedVoice = null;
    let modalCallback = null;
    let isListening = false;
    let recognition = null;
    let hasGreeted = false; // FIX: Prevent double greeting

    // Game state variables
    let ticTacToeBoard = ['','','','','','','','',''];
    let currentPlayer = 'X';

    // Initialize voices
    function loadVoices() {
        const synth = window.speechSynthesis;
        let voices = synth.getVoices();
        
        // Try to find a female voice
        selectedVoice = voices.find(v => 
            v.name.toLowerCase().includes('female') || 
            v.name.includes('Google UK English Female') ||
            v.name.includes('Microsoft Zira') ||
            v.name.includes('Samantha')
        );
        
        if (!selectedVoice) {
            selectedVoice = voices.find(v => v.lang.includes('en'));
        }
        
        if (!selectedVoice && voices.length > 0) {
            selectedVoice = voices[0];
        }
        
        if (chat.innerHTML === "" && !hasGreeted) {
            setTimeout(initGreeting, 500);
        }
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    // Text-to-speech function
    function speak(text) {
        const synth = window.speechSynthesis;
        if (synth.speaking) synth.cancel();
        
        const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');
        const utter = new SpeechSynthesisUtterance(cleanText);
        
        if (selectedVoice) utter.voice = selectedVoice;
        
        utter.pitch = 1.1;
        utter.rate = 0.95;
        utter.volume = 1;
        synth.speak(utter);
    }

    // Enhanced apps with unique features
    const apps = [
        { id: 'whatsapp', icon: 'fab fa-whatsapp', bg: 'linear-gradient(135deg, #25D366, #128C7E)', color: 'white', label: 'WA' },
        { id: 'facebook', icon: 'fab fa-facebook', bg: 'linear-gradient(135deg, #1877F2, #0D5C9E)', color: 'white', label: 'FB' },
        { id: 'youtube', icon: 'fab fa-youtube', bg: 'linear-gradient(135deg, #FF0000, #CC0000)', color: 'white', label: 'YT' },
        { id: 'github', icon: 'fab fa-github', bg: 'linear-gradient(135deg, #333, #000)', color: 'white', label: 'Git' },
        { id: 'google', icon: 'fab fa-google', bg: 'linear-gradient(135deg, #4285F4, #34A853, #FBBC05, #EA4335)', color: 'white', label: 'Ggl' },
        { id: 'gmail', icon: 'fas fa-envelope', bg: 'linear-gradient(135deg, #EA4335, #D14836)', color: 'white', label: 'Mail' },
        { id: 'linkedin', icon: 'fab fa-linkedin', bg: 'linear-gradient(135deg, #0077b5, #005582)', color: 'white', label: 'In' },
        { id: 'browser', icon: 'fas fa-globe', bg: 'linear-gradient(135deg, #f39c12, #e67e22)', color: 'white', label: 'Web' },
        { id: 'calculator', icon: 'fas fa-calculator', bg: 'linear-gradient(135deg, #e74c3c, #c0392b)', color: 'white', label: 'Calc' },
        { id: 'weather', icon: 'fas fa-cloud', bg: 'linear-gradient(135deg, #3498db, #2980b9)', color: 'white', label: 'Weather' },
        { id: 'game', icon: 'fas fa-gamepad', bg: 'linear-gradient(135deg, #2ecc71, #27ae60)', color: 'white', label: 'Game' },
        { id: 'music', icon: 'fas fa-music', bg: 'linear-gradient(135deg, #9b59b6, #8e44ad)', color: 'white', label: 'Music' }
    ];

    const grid = document.getElementById('gridContainer');
    apps.forEach(app => {
        grid.innerHTML += `<div class="app-icon" onclick="handleSystemCmd('${app.id}')">
            <i class="${app.icon}" style="background: ${app.bg}; color: ${app.color};"></i>${app.label}
        </div>`;
    });

    // FIX: Prevent double greeting
    function initGreeting() {
        if (hasGreeted) return;
        hasGreeted = true;
        
        if (!userName) {
            showWelcomeMessage();
        } else {
            addMsg(`Welcome back, ${userName}! I'm Shizuka, your AI assistant. üå∏ How can I help you today?`, false);
        }
    }

    function showWelcomeMessage() {
        const welcomeHTML = `
            <div class="welcome-container">
                <span class="welcome-icon">üå∏</span>
                <h3 style="color: var(--dark); margin-bottom: 10px;">Hello! I'm Shizuka</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                    Your intelligent AI assistant ready to help with tasks, games, and more!
                </p>
                <p style="color: var(--primary); font-weight: 600; margin-bottom: 20px;">
                    May I know your name?
                </p>
                <div class="quick-actions" style="justify-content: center;">
                    <button class="quick-action-btn" onclick="showNameModal()">Enter Name</button>
                    <button class="quick-action-btn" onclick="skipName()">Skip for now</button>
                </div>
            </div>
        `;
        chat.innerHTML = welcomeHTML;
    }

    function showNameModal() {
        showModal("What's your name?", (name) => {
            if (name && name.trim()) {
                userName = name.trim();
                sessionStorage.setItem('shizuka_user_name', userName);
                addMsg(`Nice to meet you, ${userName}! üòä How can I help you today?`, false);
                addQuickActions();
            }
        });
    }

    function skipName() {
        userName = "Guest";
        sessionStorage.setItem('shizuka_user_name', userName);
        addMsg(`Hello Guest! I'm Shizuka. üòä Feel free to ask me anything!`, false);
        addQuickActions();
    }

    function addQuickActions() {
        const actions = [
            { text: "Tell me a joke", cmd: "joke" },
            { text: "Play game", cmd: "game" },
            { text: "What time is it?", cmd: "time" },
            { text: "Show commands", cmd: "help" }
        ];
        
        const actionsHTML = `
            <div class="quick-actions">
                ${actions.map(action => 
                    `<button class="quick-action-btn" onclick="handleQuickAction('${action.cmd}')">${action.text}</button>`
                ).join('')}
            </div>
        `;
        
        const div = document.createElement('div');
        div.className = 'message assistant';
        div.innerHTML = `<div class="message-content">${actionsHTML}</div>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function handleQuickAction(cmd) {
        switch(cmd) {
            case 'joke': 
                handleUniqueCommands("tell me a joke");
                break;
            case 'game':
                startTicTacToe();
                break;
            case 'time':
                handleTimeCommand();
                break;
            case 'help':
                showHelp();
                break;
        }
    }

    function showModal(title, callback, defaultValue = '') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalInput').value = defaultValue;
        document.getElementById('modal').style.display = 'flex';
        modalCallback = callback;
        document.getElementById('modalInput').focus();
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function submitModal() {
        const value = document.getElementById('modalInput').value.trim();
        if (value && modalCallback) {
            modalCallback(value);
        }
        closeModal();
    }

    // UNIQUE COMMANDS HANDLER
    function handleUniqueCommands(text) {
        const lowText = text.toLowerCase();
        
        // Joke command
        if (lowText.includes('joke') || lowText.includes('funny') || lowText.includes('laugh')) {
            const jokes = [
                "Why don't scientists trust atoms? Because they make up everything! ü§ì",
                "Why did the chicken go to the s√©ance? To talk to the other side! üêî",
                "What do you call a fake noodle? An impasta! üçù",
                "Why did the math book look so sad? Because it had too many problems. üìö",
                "What do you call a bear with no teeth? A gummy bear! üêª"
            ];
            const joke = jokes[Math.floor(Math.random() * jokes.length)];
            addMsg(joke, false);
            return true;
        }
        
        // Sing command
        if (lowText.includes('sing') || lowText.includes('song') || lowText.includes('music')) {
            const songs = [
                "üéµ Twinkle, twinkle, little star... How I wonder what you are! üéµ",
                "üé∂ You are my sunshine, my only sunshine... üé∂",
                "üé§ Never gonna give you up, never gonna let you down... üé§",
                "üéπ Happy birthday to you, happy birthday to you... üéπ"
            ];
            const song = songs[Math.floor(Math.random() * songs.length)];
            addMsg(song, false);
            return true;
        }
        
        // Tic Tac Toe game
        if (lowText.includes('tic tac toe') || lowText.includes('play game') || lowText.includes('game')) {
            startTicTacToe();
            return true;
        }
        
        // Story command
        if (lowText.includes('story') || lowText.includes('tell me a story') || lowText.includes('fairy tale')) {
            const stories = [
                "Once upon a time, in a digital kingdom, there lived a friendly AI named Shizuka who helped everyone with their tasks...",
                "In a world of code and circuits, a special assistant was born to make humans smile and help them achieve their dreams...",
                "There was a magical forest where every tree was a computer and every flower was a beautiful interface..."
            ];
            const story = stories[Math.floor(Math.random() * stories.length)];
            addMsg(story, false);
            return true;
        }
        
        // Fact command
        if (lowText.includes('fact') || lowText.includes('interesting fact') || lowText.includes('did you know')) {
            const facts = [
                "Did you know? Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old! üçØ",
                "Octopuses have three hearts. Two pump blood to the gills, while the third pumps it to the rest of the body. üêô",
                "Bananas are berries, but strawberries aren't! üçì‚ùå üçå‚úÖ"
            ];
            const fact = facts[Math.floor(Math.random() * facts.length)];
            addMsg(fact, false);
            return true;
        }
        
        // Riddle command
        if (lowText.includes('riddle') || lowText.includes('puzzle') || lowText.includes('brain teaser')) {
            const riddles = [
                { q: "What has keys but can't open locks?", a: "A piano! üéπ" },
                { q: "What comes once in a minute, twice in a moment, but never in a thousand years?", a: "The letter 'M'! üî§" },
                { q: "I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?", a: "An echo! üîä" }
            ];
            const riddle = riddles[Math.floor(Math.random() * riddles.length)];
            addMsg(`ü§î ${riddle.q}`, false);
            setTimeout(() => addMsg(`üí° Answer: ${riddle.a}`, false), 3000);
            return true;
        }
        
        // Quote command
        if (lowText.includes('quote') || lowText.includes('inspiration') || lowText.includes('motivation')) {
            const quotes = [
                "‚ú® The only way to do great work is to love what you do. - Steve Jobs",
                "üåü Innovation distinguishes between a leader and a follower. - Steve Jobs",
                "üí´ The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt"
            ];
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            addMsg(quote, false);
            return true;
        }
        
        // Compliment command
        if (lowText.includes('compliment') || lowText.includes('flatter') || lowText.includes('nice thing')) {
            const compliments = [
                "You're doing amazing! Keep shining! ‚ú®",
                "Your smile could light up the darkest room! üòä",
                "You have a wonderful way of looking at the world! üåç"
            ];
            const compliment = compliments[Math.floor(Math.random() * compliments.length)];
            addMsg(compliment, false);
            return true;
        }
        
        return false;
    }

    // Tic Tac Toe Game Functions
    function startTicTacToe() {
        ticTacToeBoard = ['','','','','','','','',''];
        currentPlayer = 'X';
        const boardHTML = `
            <div style="text-align: center; margin: 10px 0;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">üéÆ Tic Tac Toe</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 70px); gap: 8px; margin: 15px auto; width: 226px;">
                    ${ticTacToeBoard.map((cell, index) => `
                        <button onclick="makeMove(${index})" 
                                style="width: 70px; height: 70px; border: 2px solid var(--secondary); 
                                       border-radius: 10px; font-size: 28px; font-weight: bold; 
                                       background: white; cursor: pointer; transition: 0.3s;
                                       box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            ${cell || ' '}
                        </button>
                    `).join('')}
                </div>
                <p style="color: var(--dark); font-weight: 600; margin: 10px 0;">
                    Player <span style="color: var(--primary);">${currentPlayer}</span>'s turn
                </p>
                <button onclick="resetGame()" 
                        style="padding: 10px 20px; background: var(--primary); color: white; 
                               border: none; border-radius: 25px; cursor: pointer; 
                               font-weight: 600; margin-top: 10px; transition: 0.3s;">
                    üîÑ Reset Game
                </button>
            </div>
        `;
        addMsg(boardHTML, false);
    }

    function makeMove(index) {
        if (ticTacToeBoard[index] || checkWinner()) return;
        
        ticTacToeBoard[index] = currentPlayer;
        updateGameDisplay();
        
        if (checkWinner()) {
            addMsg(`üéâ Player ${currentPlayer} wins! Congratulations! üèÜ`, false);
        } else if (ticTacToeBoard.every(cell => cell)) {
            addMsg("ü§ù It's a tie! Well played both! ü§úü§õ", false);
        } else {
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            updateGameDisplay();
        }
    }

    function checkWinner() {
        const winPatterns = [
            [0,1,2], [3,4,5], [6,7,8],
            [0,3,6], [1,4,7], [2,5,8],
            [0,4,8], [2,4,6]
        ];
        
        return winPatterns.some(pattern => {
            const [a,b,c] = pattern;
            return ticTacToeBoard[a] && 
                   ticTacToeBoard[a] === ticTacToeBoard[b] && 
                   ticTacToeBoard[a] === ticTacToeBoard[c];
        });
    }

    function updateGameDisplay() {
        const gameElements = chat.querySelectorAll('[style*="grid-template-columns: repeat(3, 70px)"]');
        if (gameElements.length > 0) {
            const gameContainer = gameElements[0].parentElement;
            gameContainer.innerHTML = `
                <h3 style="color: var(--primary); margin-bottom: 15px;">üéÆ Tic Tac Toe</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 70px); gap: 8px; margin: 15px auto; width: 226px;">
                    ${ticTacToeBoard.map((cell, index) => `
                        <button onclick="makeMove(${index})" 
                                style="width: 70px; height: 70px; border: 2px solid var(--secondary); 
                                       border-radius: 10px; font-size: 28px; font-weight: bold; 
                                       background: white; cursor: pointer; transition: 0.3s;
                                       box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            ${cell || ' '}
                        </button>
                    `).join('')}
                </div>
                <p style="color: var(--dark); font-weight: 600; margin: 10px 0;">
                    Player <span style="color: var(--primary);">${currentPlayer}</span>'s turn
                </p>
                <button onclick="resetGame()" 
                        style="padding: 10px 20px; background: var(--primary); color: white; 
                               border: none; border-radius: 25px; cursor: pointer; 
                               font-weight: 600; margin-top: 10px; transition: 0.3s;">
                    üîÑ Reset Game
                </button>
            `;
        }
    }

    function resetGame() {
        startTicTacToe();
    }

    // System command handler
    function handleSystemCmd(cmd) {
        if (cmd === 'game') {
            startTicTacToe();
            return;
        }
        
        if(cmd === 'music') {
            showModal("Search Music", (query) => {
                window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}+song`, '_blank');
            }, "Enter song name");
            return;
        }
        
        if(cmd === 'browser') {
            showModal("Enter Website URL", (url) => {
                window.open(url.includes("http") ? url : "https://" + url, '_blank');
            });
            return;
        }
        
        if(cmd === 'calculator') {
            showModal("Enter Math Expression", (expr) => {
                try {
                    const result = Function('"use strict"; return (' + expr + ')')();
                    addMsg(`${expr} = ${result}`, true);
                    addMsg(`üéØ Result: ${result}`, false);
                } catch(e) {
                    addMsg(`‚ùå Invalid calculation! Please check your expression.`, false);
                }
            });
            return;
        }

        if(cmd === 'weather') {
            showModal("Enter City Name", (city) => {
                addMsg(`Fetching weather for ${city}...`, true);
                addMsg(`‚òÅÔ∏è Weather in ${city}: You can check detailed forecast at weather.com`, false);
                setTimeout(() => {
                    window.open(`https://www.weather.com/weather/today/l/${encodeURIComponent(city)}`, '_blank');
                }, 1500);
            });
            return;
        }

        const urls = { 
            whatsapp: 'https://wa.me/', 
            facebook: 'https://facebook.com', 
            youtube: 'https://youtube.com', 
            github: 'https://github.com/mrtan-official', 
            google: 'https://google.com', 
            gmail: 'https://mail.google.com',
            linkedin: 'https://linkedin.com'
        };
        if(urls[cmd]) window.open(urls[cmd], '_blank');
    }

    function handleTimeCommand() {
        const t = new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Dhaka', hour: '2-digit', minute: '2-digit', hour12: true });
        addMsg(`‚è∞ The current time in Bangladesh is ${t}`, false);
    }

    function showHelp() {
        const helpMsg = `
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 20px; border-radius: 20px; margin: 10px 0; border: 1px solid rgba(102, 126, 234, 0.2);">
                <b style="color: var(--primary); font-size: 1.1rem;">ü§ñ Shizuka Commands Guide:</b><br><br>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <b>üéÆ Games & Fun:</b><br>
                        ‚Ä¢ "play tic tac toe"<br>
                        ‚Ä¢ "tell me a joke"<br>
                        ‚Ä¢ "sing a song"<br>
                        ‚Ä¢ "give me a riddle"
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <b>üìö Learning:</b><br>
                        ‚Ä¢ "tell me a story"<br>
                        ‚Ä¢ "give me a fact"<br>
                        ‚Ä¢ "inspire me"<br>
                        ‚Ä¢ "compliment me"
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <b>üõ†Ô∏è Utilities:</b><br>
                        ‚Ä¢ "what time is it"<br>
                        ‚Ä¢ "what's the date"<br>
                        ‚Ä¢ "what's my name"<br>
                        ‚Ä¢ "change my name to [name]"
                    </div>
                </div>
                
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    üí° <b>Tip:</b> Click on app icons below for quick actions!
                </p>
            </div>
        `;
        addMsg(helpMsg, false);
    }

    // Main message handler
    async function sendMsg() {
        const text = input.value.trim();
        if(!text) return;
        
        addMsg(text, true);
        input.value = '';
        const lowText = text.toLowerCase();

        // User name handling
        if (!userName || userName === "Guest") {
            userName = text;
            sessionStorage.setItem('shizuka_user_name', userName);
            addMsg(`Nice to meet you, ${userName}! I'm Shizuka. üòä Try asking me to tell a joke or play tic-tac-toe!`, false);
            addQuickActions();
            return;
        }

        // Change name command
        if(lowText.includes("change my name to")) {
            let n = text.replace(/change my name to/i, "").trim();
            if(n) { 
                userName = n; 
                sessionStorage.setItem('shizuka_user_name', userName); 
                addMsg(`‚úÖ Updated! I'll call you ${userName} from now on. ‚ú®`, false); 
            }
            return;
        }

        // Check unique commands first
        if (handleUniqueCommands(text)) {
            return;
        }

        // Basic commands
        if(lowText.includes("time") && (lowText.includes("what") || lowText.includes("current"))) {
            handleTimeCommand();
        }
        else if(lowText.includes("date")) {
            const d = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            addMsg(`üìÖ Today is ${d}`, false);
        }
        else if(lowText.includes("my name")) {
            addMsg(`üë§ Your name is ${userName}. üòä`, false);
        }
        else if(lowText.includes("hello") || lowText.includes("hi") || lowText.includes("hey")) {
            const greetings = [
                `Hi ${userName}! How can I help you today? üëã`,
                `Hello ${userName}! Ready to assist! üåü`,
                `Hey there ${userName}! What's on your mind? üòä`,
                `Greetings ${userName}! How may I assist you? ‚ú®`
            ];
            addMsg(greetings[Math.floor(Math.random() * greetings.length)], false);
        }
        else if(lowText.includes("tanim") || lowText.includes("developer") || lowText.includes("creator")) {
            const devInfo = `
                <div class="ai-response">
                    <b style="color: var(--primary);">üë®‚Äçüíª Abu Tanim</b> - My Creator<br><br>
                    üéì <b>Education:</b> BSc in CSE at Premier University<br>
                    üìç <b>Location:</b> Chittagong, Bangladesh<br>
                    üêç <b>Expertise:</b> Python Expert & Full Stack Developer<br>
                    üéÇ <b>Birthday:</b> September 20<br><br>
                    üîó <b>GitHub:</b> <a href="https://github.com/mrtan-official" target="_blank">github.com/mrtan-official</a><br>
                    üìß <b>Email:</b> <a href="mailto:abu.tanim.official@gmail.com">abu.tanim.official@gmail.com</a>
                </div>`;
            addMsg(devInfo, false);
        }
        else if(lowText.includes("help") || lowText.includes("commands")) {
            showHelp();
        }
        else if(lowText.includes("thank") || lowText.includes("thanks")) {
            const responses = [
                `You're welcome, ${userName}! üòä Always happy to help!`,
                `My pleasure, ${userName}! üå∏`,
                `Anytime, ${userName}! Feel free to ask more! ‚ú®`
            ];
            addMsg(responses[Math.floor(Math.random() * responses.length)], false);
        }
        else if(lowText.includes("bye") || lowText.includes("goodbye")) {
            addMsg(`Goodbye ${userName}! Have a wonderful day! üëãüå∏`, false);
        }
        else if(lowText.includes("open ")) {
            const app = lowText.replace("open ", "").trim();
            handleSystemCmd(app);
        }
        else {
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chat.appendChild(typingDiv);
            chat.scrollTop = chat.scrollHeight;
            
            try {
                const res = await fetch(`${API_URL}/api/query`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ query: text }) 
                });
                const data = await res.json();
                
                // Remove typing indicator
                chat.removeChild(typingDiv);
                
                addMsg(data.text || "I understand! üòä", false);
            } catch(e) {
                // Remove typing indicator
                chat.removeChild(typingDiv);
                
                // Fallback response
                const fallbackResponses = [
                    `I'm not sure about that, ${userName}. Try asking me something else! üòä`,
                    `That's interesting, ${userName}! Could you rephrase that? üå∏`,
                    `I'm still learning, ${userName}! Maybe try one of my special commands? ‚ú®`
                ];
                addMsg(fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)], false);
            }
        }
    }

    // Add message to chat
    function addMsg(text, isUser) {
        const div = document.createElement('div');
        div.className = `message ${isUser ? 'user' : 'assistant'}`;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        div.innerHTML = `
            <div class="message-content">${text}</div>
            <div class="time-stamp">${time}</div>
        `;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        
        if(!isUser && !text.includes('<button') && !text.includes('<input')) {
            speak(div.innerText.replace(/\n/g, ' '));
        }
    }

    // Voice recognition
    function toggleVoice() {
        const micBtn = document.getElementById('mic');
        
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            addMsg("Voice recognition is not supported in your browser. üòî", false);
            return;
        }

        if (isListening) {
            stopListening();
            micBtn.classList.remove('listening');
            isListening = false;
        } else {
            startListening();
            micBtn.classList.add('listening');
            isListening = true;
        }
    }

    function startListening() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
            addMsg("üé§ Listening... Speak now!", true);
        };
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            input.value = transcript;
            setTimeout(() => sendMsg(), 500);
        };
        
        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            if (event.error !== 'aborted') {
                addMsg("Sorry, I couldn't hear that clearly. üéß", false);
            }
        };
        
        recognition.onend = () => {
            const micBtn = document.getElementById('mic');
            micBtn.classList.remove('listening');
            isListening = false;
        };
        
        try {
            recognition.start();
        } catch(e) {
            console.error('Recognition start error:', e);
        }
    }

    function stopListening() {
        if (recognition) {
            try {
                recognition.stop();
            } catch(e) {
                console.error('Recognition stop error:', e);
            }
        }
    }

    // Event listeners
    input.addEventListener('keypress', (e) => { 
        if(e.key === 'Enter') sendMsg(); 
    });
    
    // Initialize on load
    window.addEventListener('load', () => {
        // No need to call initGreeting here - it's called from loadVoices
    });
</script>
</body>
</html>
